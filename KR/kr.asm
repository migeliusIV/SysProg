;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; tsr.asm
;
; ?ö? òÿ:
;  tasm.exe /l tsr.asm
;  tlink /t /x tsr.obj
;
;  ???? ð?. ?.?. ?ÿ£?ÿ?ÿ, ??5-45?, 2024 ?.
;  ?? ?¯ò?÷ ?. ?.
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

code segment	'code'
	assume	CS:code, DS:code
	org	100h
	_start:

	jmp _initTSR ; ?ÿ ?ÿ§ÿ?? ô ?? ÿ??«

	; ýÿ??«?
	replaceWith 				DB	'' ;
	ignoredChars                DB  '1234567890'
	ignoredLength 				equ	$-ignoredChars ; ý?ð?ÿ ¡¢ ?òð ignoredChars
	ignoreEnabled 				DB	0	; ¤?ÿ? ¤£?ò¦ðð ð??? ð ?÷ÿ?ð¯ ÷÷?ýÿ
	translateFrom 				DB	'HCNEA'	; ¡ð?÷??« ý?¯ ?ÿ???« (????? ?ÿ ÿ???.  ÿ¡ò?ÿýò?)
	translateTo 					DB	'?????'	; ¡ð?÷??« ?ÿ ò?¢? «? ö£ý?¢ ðý¢ð ?ÿ???ÿ'	; ¡ð?÷??« ?ÿ ò?¢? «? ö£ý?¢ ðý¢ð ?ÿ???ÿ
	translateLength				equ	$-translateTo	; ý?ð?ÿ ¡¢ ?òð trasnlateFrom
	translateEnabled			DB	0	; ¤?ÿ? ¤£?ò¦ðð ô? ?÷?ýÿ

	signaturePrintingEnabled 		DB	0	; ¤?ÿ? ¤£?ò¦ðð ÷«÷?ýÿ ð?¤? ?ÿ¦ðð ?ö ÿ÷¢? ?
	cursiveEnabled 				DB	0	; ¤?ÿ? ô? ?÷?ýÿ ¡ð?÷??ÿ ÷ ò£ ¡ð÷


	cursiveSymbol 	DB 00000000b ; ¡ð?÷??, ¡?¡¢ÿ÷????«? ð? ?ýð?ð§?ò (??? ò£ ¡ð÷?«? ÷ÿ ðÿ?¢)
		       	    DB 00000000b
					DB 01100011b
					DB 01100110b
					DB 01101100b
					DB 01111000b
					DB 01110000b
					DB 01110000b
					DB 01111000b
					DB 01101100b
					DB 01100110b
					DB 01100011b
					DB 00000000b
					DB 00000000b
					DB 00000000b




	charToCursiveIndex 		DB '?' ; ¡ð?÷?? ý?¯ ?ÿ???«
	savedSymbol 					DB 16 dup(0FFh)	; ô? ?????ÿ¯ ý?¯ ¥ ÿ???ð¯ ¡¢ÿ ??? ¡ð?÷??ÿ

	true 								 	equ	0FFh ; ò??¡¢ÿ?¢ÿ ð¡¢ð???¡¢ð
	old_int9hOffset 				DW	?	; ÿý ?¡ ¡¢ÿ ??? ?ö ÿö?¢§ðòÿ int 9h
	old_int9hSegment 				DW	?	; ¡?????¢ ¡¢ÿ ??? ?ö ÿö?¢§ðòÿ int 9h
	old_int1ChOffset 				DW	?	; ÿý ?¡ ¡¢ÿ ??? ?ö ÿö?¢§ðòÿ int 1Ch
	old_int1ChSegment 			DW	?	; ¡?????¢ ¡¢ÿ ??? ?ö ÿö?¢§ðòÿ int 1Ch
	old_int2FhOffset 				DW	?	; ÿý ?¡ ¡¢ÿ ??? ?ö ÿö?¢§ðòÿ int 2Fh
	old_int2FhSegment 			DW	?	; ¡?????¢ ¡¢ÿ ??? ?ö ÿö?¢§ðòÿ int 2Fh

	unloadTSR						DB	0 ; 1 - ÷«? £?ð¢¬  ??ðý??¢
	notLoadTSR					DB	0	; 1 - ?? ?ÿ? £?ÿ¢¬
	counter	  					DW	0
	printDelay					equ	3 ; ?ÿý? ?òÿ ô? ?ý ÷«÷?ý?? "ô?ýôð¡ð" ÷ ¡?ò£?ýÿ¥
	printPos						DW	1 ; ô??????ð? ô?ýôð¡ð ?ÿ ­ò ÿ??. 0 - ÷? ¥, 1 - ¦??¢ , 2 - ?ð?

	;@ ?ÿ???ð¢¬ ?ÿ ¡?ö¡¢÷???«? ýÿ??«?. ¤? ?ð ?÷ÿ?ð? ¢ÿö?ð¦« ðý?¢ ô? ¡¢ ?ò? ö??¬¨?? ý?ð?« (1¯ ¡¢ ?òÿ).
	signatureLine1				DB	179, '?? ?¯ò?÷ ?????                                    ', 179
	Line1_length 					equ	$-signatureLine1
	signatureLine2				DB	179, '??5-45?                                           ', 179
	Line2_length 					equ	$-signatureLine2
	signatureLine3				DB	179, '?ÿ ðÿ?¢ #12                                       ', 179
	Line3_length 					equ	$-signatureLine3
	helpMsg DB '>tsr.com [/?] ', 10, 13
					DB ' [/?] - ÷«÷?ý ýÿ???? ¡ô ÿ÷òð', 10, 13
					DB ' UNLDTSR.COM - ÷«? £?òÿ  ??ðý??¢ÿ ð? ôÿ?¯¢ð', 10, 13
					DB '  F1  - ÷«÷?ý ??? ð ? £ôô« ô? ¢ÿ??? £ ÷ ¦??¢ ? ­ò ÿ?ÿ', 10, 13
					DB '  F2  - ÷ò?®§??ð? ð ?¢ò?®§??ð¯ ò£ ¡ð÷???? ÷«÷?ýÿ  £¡¡ò??? ¡ð?÷??ÿ ?', 10, 13
					DB '  F3  - ÷ò?®§??ð? ð ?¢ò?®§??ð? §ÿ¡¢ð§???  £¡ð¤ðòÿ¦ðð ò?ÿ÷ðÿ¢£ «(HCNEA -> ?????)', 10, 13
					DB '  F4  - ÷ò?®§??ð? ð ?¢ò?®§??ð?  ??ð?ÿ ?? ÿ?ð§ð¢¬ ÷÷?ý: ?ð¤ ', 10, 13

	helpMsg_length				equ  $-helpMsg
	errorParamMsg					DB	'?¨ðöòÿ ôÿ ÿ??¢ ?÷ ò???ÿ?ý??? ¡¢ ?òð', 10, 13
	errorParamMsg_length	equ	$-errorParamMsg

	tableTop						DB	218, Line1_length-2 dup (196), 191
	tableTop_length 		equ	$-tableTop
	tableBottom					DB	192, Line1_length-2 dup (196), 217
	tableBottom_length 	equ  $-tableBottom

	; ¡??ö©??ð¯
	installedMsg					DB  '???ðý??¢ ?ÿ? £???!$'
	alreadyInstalledMsg		DB  '???ðý??¢ £?? ?ÿ? £???$'
	noMemMsg						  DB  '??ý?¡¢ÿ¢?§?? ôÿ?¯¢ð$'
	notInstalledMsg				DB  '?? £ýÿ??¡¬ ?ÿ? £?ð¢¬  ??ðý??¢$'

	removedMsg					DB  '???ðý??¢ ÷«? £???'
	removedMsg_length		equ	$-removedMsg

	noRemoveMsg					DB  '?? £ýÿ??¡¬ ÷«? £?ð¢¬  ??ðý??¢'
	noRemoveMsg_length	equ	$-noRemoveMsg

	f1_txt						DB	'F1'
	f2_txt						DB	'F2'
	f3_txt						DB	'F3'
	f4_txt						DB	'F4'
	fx_length					equ	$-f4_txt

	changeFx proc
		push AX
		push BX
		push CX
		push DX
		push BP
		push ES
		xor BX, BX

		mov AH, 03h
		int 10h
		push DX

		push CS
		pop ES

	_checkF1:
		lea BP, f1_txt
		mov CX, fx_length
		mov BH, 0
		mov DH, 0
		mov DL, 78
		mov AX, 1301h

		cmp signaturePrintingEnabled, true
		je _greenF1

		_redF1:
			mov BL, 01001111b ; red
			int 10h
			jmp _checkF2

		_greenF1:
			lea BP, f1_txt
			mov BL, 00101111b ; green
			int 10h

	_checkF2:
		lea BP, f2_txt
		mov CX, fx_length
		mov BH, 0
		mov DH, 1
		mov DL, 78
		mov AX, 1301h

		cmp cursiveEnabled, true
		je _greenF2

		_redF2:
			mov BL, 01001111b ; red
			int 10h
			jmp _checkF3

		_greenF2:
			mov BL, 00101111b ; green
			int 10h

	_checkF3:
		lea BP, f3_txt
		mov CX, fx_length
		mov BH, 0
		mov DH, 2
		mov DL, 78
		mov AX, 1301h

		cmp translateEnabled, true
		je _greenF3

		_redF3:
			mov BL, 01001111b ; red
			int 10h
			jmp _checkF4

		_greenF3:
			mov BL, 00101111b ; green
			int 10h

	_checkF4:
		lea BP, f4_txt
		mov CX, fx_length
		mov BH, 0
		mov DH, 3
		mov DL, 78
		mov AX, 1301h

		cmp ignoreEnabled, true
		je _greenF4

		_redF4:
			mov BL, 01001111b ; red
			int 10h
			jmp _outFx

		_greenF4:
			mov BL, 00101111b ; green
			int 10h
			
	_outFx:
		pop DX
		mov AH, 02h
		int 10h

		pop ES
		pop BP
		pop DX
		pop CX
		pop BX
		pop AX
		ret
	changeFx endp

    ;??÷«? ?ö ÿö?¢§ðò
    new_int9h proc far
		; ¡?¥ ÿ?¯?? ??ÿ§??ð¯ ÷¡?¥, ð????¯??«¥  ??ð¡¢ ?÷ ÷ ¡¢­ò?
		push SI
		push AX
		push BX
		push CX
		push DX
		push ES
		push DS
		; ¡ð?¥ ??ð?ð £?? CS ð DS
		push CS
		pop	DS

		mov	AX, 40h ; 40h-¡?????¢,?ý? ¥ ÿ?¯¢¡¯ ¤?ÿ?ð ¡?¡¢-¯ ò?ÿ÷ðÿ¢£ «, ò??¬¦. ö£¤?  ÷÷?ýÿ
		mov	ES, AX
		in	AL, 60h	; ?ÿôð¡«÷ÿ?? ÷ AL ¡òÿ?-ò?ý ?ÿ?ÿ¢?? ò?ÿ÷ð¨ð

		

		
		;@ ýÿ??? - ò?ý ý?¯ ÷¡?¥ ÷ÿ ðÿ?¢?÷

		;ô ?÷? òÿ F1-F4
		_test_Fx:
		sub AL, 58 ; ÷ AL ¢?ô? ¬ ????  ¤£?ò¦ð??ÿ?¬??? ò?ÿ÷ð¨ð
		_F1:
			cmp AL, 1 ; F1
			jne _F2
			not signaturePrintingEnabled
			call changeFx
			jmp _translate_or_ignore
		_F2:
			cmp AL, 2 ; F2
			jne _F3
			not cursiveEnabled
			call changeFx
			call setCursive ; ô? ?÷?ý ¡ð?÷??ÿ ÷ ò£ ¡ð÷ ð ?ö ÿ¢?? ÷ ?ÿ÷ð¡ð??¡¢ð ?¢ ¤?ÿ?ÿ cursiveEnabled
			jmp _translate_or_ignore
		_F3:
			cmp AL, 3 ; F3
			jne _F4
			not translateEnabled
			call changeFx
			jmp _translate_or_ignore
		_F4:
			cmp AL, 4 ; F4
			jne _translate_or_ignore
			not ignoreEnabled
			call changeFx
			jmp _translate_or_ignore

		;ð??? ð ?÷ÿ?ð? ð ô? ?÷?ý
		_translate_or_ignore:

		pushf
		call dword ptr CS:[old_int9hOffset] ; ÷«?«÷ÿ?? ¡¢ÿ?ýÿ ¢?«? ?ö ÿö?¢§ðò ô ? «÷ÿ?ð¯
		mov	AX, 40h 	; 40h-¡?????¢,?ý? ¥ ÿ?¯¢¡¯ ¤?ÿ?ð ¡?¡¢-¯ ò?ÿ÷«,ò??¬¦. ö£¤?  ÷÷?ýÿ
		mov	ES, AX
		mov	BX, ES:[1Ch]	; ÿý ?¡ ¥÷?¡¢ÿ
		dec	BX	; ¡??¡¢ð?¡¯ ?ÿ?ÿý ò ô?¡??ý???£
		dec	BX	; ÷÷?ýá????£ ¡ð?÷??£
		cmp	BX, 1Eh	; ?? ÷«¨?ð ?ð ?« ?ÿ ô ?ý??« ö£¤? ÿ?
		jae	_go
		mov	BX, 3Ch	; ¥÷?¡¢ ÷«¨?? ?ÿ ô ?ý??« ö£¤? ÿ, ??ÿ§ð¢ ô?¡??ý?ð? ÷÷?ýá??«? ¡ð?÷??
				    ; ?ÿ¥?ýð¢¡¯	÷ ò??¦? ö£¤? ÿ

	_go:
		mov DX, ES:[BX] ; ÷ DX 0 ÷÷?ýá??«? ¡ð?÷??
		;÷ò?®§?? ?ð  ??ð? ö??òð ?÷òð ÷÷?ýÿ?
		cmp ignoreEnabled, true
		jne _check_translate

		; ýÿ, ÷ò?®§??
		mov SI, 0
		mov CX, ignoredLength ;ò??-÷? ð??? ð £??«¥ ¡ð?÷???÷

		; ô ?÷? ¯??, ô ð¡£¢¡¢÷£?¢ ?ð ¢?ò£©ð? ¡ð?÷?? ÷ ¡ôð¡ò? ð??? ð £??«¥
	_check_ignored:
		cmp DL,ignoredChars[SI]
		je _block
		inc SI
	loop _check_ignored
		jmp _check_translate

	; ö??òð £??
	_block:
		;mov ES:[1Ch], BX ;ö??òð ?÷òÿ ÷÷?ýÿ ¡ð?÷??ÿ
		;@ ?¡?ð ô? ÷ÿ ðÿ?¢£ ?£??? ?? ö??òð ?÷ÿ¢¬ ÷÷?ý ¡ð?÷??ÿ,
		;@ ÿ ?ÿ???¯¢¬ ?ý?ð ¡ð?÷??« ý £?ð?ð,
		;@ ?ÿ???ð¢? ¡¢ ?ò£ ÷«¨? ¡¢ ?ò??
		;mov ES:[BX], AX
		;@ ?ÿ ??¡¢? AX ????¢ ö«¢¬ '*' ý?¯ ?ÿ???« ÷¡?¥ ¡ð?÷???÷ ?????¡¢÷ÿ ignoredChars ?ÿ ?÷á?ý?§òð
		;@ ð?ð, ý?¯ ô? ?÷?ýÿ ?ý?ð¥ ¡ð?÷???÷ ÷ ý £?ð? - ?ÿ÷?¡¢ð ?ÿ¡¡ð÷
		;@ replaceWith DB '...', ?ý? ô? ?§ð¡?ð¢¬ ¡ð?÷??«, ?ÿ ò?¢? «? ô??ýá¢ ?ÿ???ÿ
		;@ ð  ÿ¡ò?????¢ð ?÷ÿ¢¬ ¡¢ ?òð ?ð??:
		  xor AX, AX
		  mov AL, replaceWith[SI]
		  mov ES:[1Ch], BX	;ö??òð ?÷òÿ ÷÷?ýÿ 
		jmp _quit

	_check_translate:
		; ÷ò?®§?? ?ð  ??ð? ô? ?÷?ýÿ?
		cmp translateEnabled, true
		jne _quit

		; ýÿ, ÷ò?®§??
		mov SI, 0
		mov CX, translateLength ; ò??-÷? ¡ð?÷???÷ ý?¯ ô? ?÷?ýÿ
		; ô ?÷? ¯??, ô ð¡£¢¡¢÷£?¢ ?ð ¢?ò£©ð? ¡ð?÷?? ÷ ¡ôð¡ò? ý?¯ ô? ?÷?ýÿ
		_check_translate_loop:
			cmp DL, translateFrom[SI]
			je _translate
			inc SI
		loop _check_translate_loop
		jmp _quit

		; ô? ?÷?ýð?
		_translate:
			xor AX, AX
			mov AL, translateTo[SI]
			mov ES:[BX], AX	; ?ÿ???ÿ ¡ð?÷??ÿ

	_quit:
		; ÷?¡¡¢ÿ?ÿ÷?ð÷ÿ?? ÷¡?  ??ð¡¢ «
		pop	DS
		pop	ES
		pop DX
		pop CX
		pop	BX
		pop	AX
		pop SI
		iret
new_int9h endp

;=== ?ö ÿö?¢§ðò ô ? «÷ÿ?ð¯ int 1Ch ===;
;=== ?«?«÷ÿ?¢¡¯ òÿ?ý«? 55 ?¡ ===;
new_int1Ch proc far
	push AX
	push CS
	pop DS

	pushf
	call dword ptr CS:[old_int1ChOffset]

	cmp signaturePrintingEnabled, true ; ?¡?ð ?ÿ?ÿ¢ÿ £ô ÿ÷?¯®©ÿ¯ ò?ÿ÷ð¨ÿ (÷ ýÿ???? ¡?£§ÿ? F2)
	jne _notToPrint

		cmp counter, printDelay*1000/55 + 1 ; ?¡?ð ò??-÷? "¢ÿò¢?÷" ­ò÷ð÷ÿ???¢?? %printDelay% ¡?ò£?ýÿ?
		je _letsPrint

		jmp _dontPrint

		_letsPrint:
			not signaturePrintingEnabled
			mov counter, 0
			call printSignature

		_dontPrint:
			add counter, 1

	_notToPrint:

	pop AX

	iret
new_int1Ch endp

;=== ?ö ÿö?¢§ðò ô ? «÷ÿ?ð¯ int 2Fh ===;
;=== ??£?ð¢ ý?¯:
;===  1) ô ?÷? òð ¤ÿò¢ÿ ô ð¡£¢¡¢÷ð¯ TSR ÷ ôÿ?¯¢ð (ô ð AH=0FFh, AL=0)
;===     ö£ý?¢ ÷??÷ ÿ©á? AH='i' ÷ ¡?£§ÿ?, ?¡?ð TSR £?? ?ÿ? £???
;===  2) ÷«? £?òð TSR ð? ôÿ?¯¢ð (ô ð AH=0FFh, AL=1)
;===
new_int2Fh proc
	cmp	AH, 0FFh	;?ÿ¨ÿ ¤£?ò¦ð¯?
	jne	_2Fh_std	;??¢ - ?ÿ ¡¢ÿ «? ?ö ÿö?¢§ðò
	cmp	AL, 0	;ô?ý¤£?ò¦ð¯ ô ?÷? òð, ?ÿ? £??? ?ð  ??ðý??¢ ÷ ôÿ?¯¢¬?
	je	_already_installed
	cmp	AL, 1	;ô?ý¤£?ò¦ð¯ ÷«? £?òð ð? ôÿ?¯¢ð?
	je	_uninstall
	jmp	_2Fh_std	;??¢ - ?ÿ ¡¢ÿ «? ?ö ÿö?¢§ðò

_2Fh_std:
	jmp	dword ptr CS:[old_int2FhOffset]	;÷«??÷ ¡¢ÿ ??? ?ö ÿö?¢§ðòÿ

_already_installed:
		mov	AH, 'i'	;÷? ?á? 'i', ?¡?ð  ??ðý??¢ ?ÿ? £???	÷ ôÿ?¯¢¬
		iret

_uninstall:
	push	DS
	push	ES
	push	DX
	push	BX

	xor BX, BX

	; CS = ES, ý?¯ ý?¡¢£ôÿ ò ô? ?????«?
	push CS
	pop ES

	mov	AX, 2509h
	mov DX, ES:old_int9hOffset         ; ÷??÷ ÿ©ÿ?? ÷?ò¢?  ô ? «÷ÿ?ð¯
    mov DS, ES:old_int9hSegment        ; ?ÿ ??¡¢?
	int	21h

	mov	AX, 251Ch
	mov DX, ES:old_int1ChOffset         ; ÷??÷ ÿ©ÿ?? ÷?ò¢?  ô ? «÷ÿ?ð¯
    mov DS, ES:old_int1ChSegment        ; ?ÿ ??¡¢?
	int	21h

	mov	AX, 252Fh
	mov DX, ES:old_int2FhOffset         ; ÷??÷ ÿ©ÿ?? ÷?ò¢?  ô ? «÷ÿ?ð¯
    mov DS, ES:old_int2FhSegment        ; ?ÿ ??¡¢?
	int	21h

	mov	ES, CS:2Ch	; ?ÿ? £?ð? ÷ ES ÿý ?¡ ?ò £???ð¯
	mov	AH, 49h		; ÷«? £?ð? ð? ôÿ?¯¢ð ?ò £???ð?
	int	21h
	jc _notRemove

	push	CS
	pop	ES	;÷ ES - ÿý ?¡  ??ðý??¢??? ô ?? ÿ??«
	mov	AH, 49h  ;÷«? £?ð? ð? ôÿ?¯¢ð  ??ðý??¢
	int	21h
	jc _notRemove
	jmp _unloaded

_notRemove: ; ?? £ýÿ??¡¬ ÷«ô???ð¢¬ ÷«? £?ò£
    ; ÷«÷?ý ¡??ö©??ð¯ ? ??£ýÿ§??? ÷«? £?ò?
	mov AH, 03h					; ô??£§ÿ?? ô??ð¦ð® ò£ ¡? ÿ
	int 10h
	lea BP, noRemoveMsg
	mov CX, noRemoveMsg_length
	mov BL, 0111b
	mov AX, 1301h
	int 10h
	jmp _2Fh_exit

_unloaded: ; ÷«? £?òÿ ô ?¨?ÿ £¡ô?¨??
    ; ÷«÷?ý ¡??ö©??ð¯ ?ö £ýÿ§??? ÷«? £?ò?
	mov AH, 03h					; ô??£§ÿ?? ô??ð¦ð® ò£ ¡? ÿ
	int 10h
	lea BP, removedMsg
	mov CX, removedMsg_length
	mov BL, 0111b
	mov AX, 1301h
	int 10h

_2Fh_exit:
	pop BX
	pop	DX
	pop	ES
	pop	DS
	iret
new_int2Fh endp

;=== ? ?¦?ý£ ÿ ÷«÷?ýÿ ô?ýôð¡ð (???, ? £ôôÿ)
;=== ?ÿ¡¢ ÿð÷ÿ?¢¡¯ ??ÿ§??ð¯?ð ô? ?????«¥ ÷ ?ÿ§ÿ?? ð¡¥?ý?ðòÿ
;===
printSignature proc
	push AX
	push DX
	push CX
	push BX
	push ES
	push SP
	push BP
	push SI
	push DI

	xor AX, AX
	xor BX, BX
	xor DX, DX

	mov AH, 03h						;§¢??ð? ¢?ò£©?? ô??ð¦ðð ò£ ¡? ÿ
	int 10h
	push DX							;ô???©ÿ?? ð?¤? ?ÿ¦ð® ? ô??????ðð ò£ ¡? ÿ ÷ ¡¢?ò

	cmp printPos, 0
	je _printTop

	cmp printPos, 1
	je _printCenter

	cmp printPos, 2
	je _printBottom

	;÷¡? §ð¡?ÿ ô?ý?ö ÿ?« ?ÿ ??ÿ?...
	_printTop:
		mov DH, 0
		mov DL, 15
		jmp _actualPrint

	_printCenter:
		mov DH, 9
		mov DL, 15
		jmp _actualPrint

	_printBottom:
		mov DH, 19
		mov DL, 15
		jmp _actualPrint

	_actualPrint:
		mov AH, 0Fh					;§¢??ð? ¢?ò£©??? ÷ðý?? ??ð?ÿ. ÷ BH - ¢?ò£©ÿ¯ ¡¢ ÿ?ð¦ÿ
		int 10h

		push CS
		pop ES						;£òÿ?«÷ÿ?? ES ?ÿ CS

		;÷«÷?ý '÷? ¥£¨òð' ¢ÿö?ð¦«
		push DX
		lea BP, tableTop				;ô???©ÿ?? ÷ BP £òÿ?ÿ¢??¬ ?ÿ ÷«÷?ýð?£® ¡¢ ?ò£
		mov CX, tableTop_length		;÷ CX - ý?ð?ÿ ¡¢ ?òð
		mov BL, 0111b 				;¦÷?¢ ÷«÷?ýð???? ¢?ò¡¢ÿ ref: http://en.wikipedia.org/wiki/BIOS_color_attributes
		mov AX, 1301h					;AH=13h - ????  ¤-ðð, AL=01h - ò£ ¡?  ô? ???©ÿ?¢¡¯ ô ð ÷«÷?ý? òÿ?ý??? ð? ¡ð?÷???÷ ¡¢ ?òð
		int 10h
		pop DX
		inc DH


		;÷«÷?ý ô? ÷?? ?ð?ðð
		push DX
		lea BP, signatureLine1
		mov CX, Line1_length
		mov BL, 0111b
		mov AX, 1301h
		int 10h
		pop DX
		inc DH

		;÷«÷?ý ÷¢? ?? ?ð?ðð
		push DX
		lea BP, signatureLine2
		mov CX, Line2_length
		mov BL, 0111b
		mov AX, 1301h
		int 10h
		pop DX
		inc DH

		;÷«÷?ý ¢ ?¢¬?? ?ð?ðð
		push DX
		lea BP, signatureLine3
		mov CX, Line3_length
		mov BL, 0111b
		mov AX, 1301h
		int 10h
		pop DX
		inc DH

		;÷«÷?ý '?ð?ÿ' ¢ÿö?ð¦«
		push DX
		lea BP, tableBottom
		mov CX, tableBottom_length
		mov BL, 0111b
		mov AX, 1301h
		int 10h
		pop DX
		inc DH

		xor BX, BX
		pop DX						;÷?¡¡¢ÿ?ÿ÷?ð÷ÿ?? ð? ¡¢?òÿ ô ????? ô??????ð? ò£ ¡? ÿ
		mov AH, 02h					;???¯?? ô??????ð? ò£ ¡? ÿ ?ÿ ô? ÷??ÿ§ÿ?¬???
		int 10h
		call changeFx

	pop DI
	pop SI
	pop BP
	pop SP
	pop ES
	pop BX
	pop CX
	pop DX
	pop AX

	ret
printSignature endp

;=== ?£?ò¦ð¯, ò?¢? ÿ¯ ÷ ?ÿ÷ð¡ð??¡¢ð ?¢ ¤?ÿ?ÿ cursiveEnabled ???¯?¢ ?ÿ§? ¢ÿ?ð? ¡ð?÷??ÿ ¡ ò£ ¡ð÷ÿ ?ÿ ?ö«§??? ð ?ÿ?ö ?¢
;=== ?ÿ?ÿ ¡???ÿ ô ?ð¡¥?ýð¢ ÷ ô ?¦?ý£ ? changeFont, ÿ ?ý?¡¬ ô?ý??¢ÿ÷?ð÷ÿ®¢¡¯ ýÿ??«?
setCursive proc
	push ES ; ¡?¥ ÿ?¯??  ??ð¡¢ «
	push AX
	push CS
	pop ES

	cmp cursiveEnabled, true
	jne _restoreSymbol
	; ?¡?ð ¤?ÿ?  ÿ÷?? true, ÷«ô???¯?? ?ÿ???£ ¡ð?÷??ÿ ?ÿ ò£ ¡ð÷?«? ÷ÿ ðÿ?¢,
	; ô ?ý÷ÿ ð¢??¬?? ¡?¥ ÿ?¯¯ ¡¢ÿ «? ¡ð?÷?? ÷ savedSymbol

	call saveFont
	mov CL, charToCursiveIndex
_shifTtable:
	; ?« ô??£§ÿ?? ÷ BP ¢ÿö?ð¦£ ÷¡?¥ ¡ð?÷???÷. ÿý ?¡ £òÿ?«÷ÿ?¢ ?ÿ ¡ð?÷?? 0
	; ô?­¢??£ ?£­?? ¡?÷? ¨ð¢¬ ¡ý÷ð? 16*X - ?ý? X - ò?ý ¡ð?÷??ÿ
	add BP, 16
	loop _shiftTable

	; ôpð savefont ¡??©ÿ?¢¡¯ p??ð¡¢p ES
	; ô?­¢??y ôpð¥?ýð¢¡¯ ý??ÿ¢¬ ¢ÿòð? ?ÿ¥ð?ÿ¦ðð, §¢?ö«
	; ?ÿôð¡ÿ¢¬ ô??y§???«? ­?????¢ ÷ savedSymbol
	; swap(ES, DS) ð ¡?¥ ÿ???ð? ¡¢ÿ ??? ??ÿ§??ð¯ DS
	push DS
	pop AX
	push ES
	pop DS
	push AX
	pop ES
	push AX

	mov SI, BP
	lea DI, savedSymbol
	; ¡?¥pÿ?¯?? ÷ ô?p?????y® savedSymbol
	; ¢ÿö?ð¦y ?y????? ¡ð?÷??ÿ
	mov CX, 16
	; movsb ð? DS:SI ÷ ES:DI
	rep movsb
	; ð¡¥?ý?«? ô??ð¦ðð ¡?????¢?÷ ÷??÷pÿ©??«
	pop DS ; ÷?¡¡¢ÿ??÷???ð? DS

	; ?ÿ???ð? ?ÿôð¡ÿ?ð? ¡ð?÷??ÿ ?ÿ òyp¡ð÷
	mov CX, 1
	mov DH, 0
	mov DL, charToCursiveIndex
	lea BP, cursiveSymbol
	call changeFont
	jmp _exitSetCursive

_restoreSymbol:
	; ?¡?ð ¤?ÿ?  ÿ÷?? 0, ÷«ô???¯?? ?ÿ???£ ò£ ¡ð÷???? ¡ð?÷??ÿ ?ÿ ¡¢ÿ «? ÷ÿ ðÿ?¢

	mov CX, 1
	mov DH, 0
	mov DL, charToCursiveIndex
	lea bp, savedSymbol
	call changeFont

_exitSetCursive:
	pop AX
	pop ES
	ret
setCursive endp

;=== ?£?ò¦ð¯ ¡???« ?ÿ§? ¢ÿ?ð¯ ¡ð?÷??ÿ (ò£ ¡ð÷/?? ?ÿ?¬???)
;===
; *** ÷¥?ý?«? ýÿ??«?
; DL = ????  ¡ð?÷??ÿ ý?¯ ?ÿ???«
; CX = ???-÷? ¡ð?÷???÷ ?ÿ???¯??«¥ ð??ö ÿ???ð? ¡ð?÷???÷
; (?ÿ§ð?ÿ¯ ¡ ¡ð?÷??ÿ £òÿ?ÿ????? ÷ DX)
; ES:bp = ÿý ?¡ ¢ÿö?ð¦«
;
; *** ?ôð¡ÿ?ð?  ÿö?¢« ô ?¦?ý£ «
; ? ?ð¡¥?ýð¢ ÷«??÷ int 10h (÷ðý??¡? ÷ð¡)
; ¡ ¤£?ò¦ð?? AH = 11h (¤£?ò¦ðð ??ÿò????? ÿ¢? ÿ)
; ?ÿ ÿ??¢  AL = 0 ¡??ö©ÿ?¢, §¢? ö£ý?¢ ?ÿ?????? ð??ö ÿ???ð?
; ¡ð?÷??ÿ ý?¯ ¢?ò£©??? ¨ ð¤¢ÿ
; ? ¡?£§ÿ¯¥, ò??ýÿ AL = 1 ð?ð 2, ö£ý?¢ ?ÿ?????? ð??ö ÿ???ð?
; ¢??¬ò? ý?¯ ?ô ?ý??????? ¨ ð¤¢ÿ (8x14 ð 8x8 ¡??¢÷?¢¡¢÷????)
; ?ÿ ÿ??¢  BH = 0Eh ¡??ö©ÿ?¢, §¢? ?ÿ ?ô ?ý???ð? òÿ?ý??? ð??ö ÿ???ð¯ ¡ð?÷??ÿ
;  ÿ¡¥?ý£?¢¡¯ ô? 14 öÿ?¢ ( ??ð? 8x14 öð¢ òÿò  ÿ? 14 öÿ?¢)
; ?ÿ ÿ??¢  BL = 0 - ö??ò ¨ ð¤¢ÿ ý?¯ ?ÿ? £?òð (?¢ 0 ý? 4)
;
; ***  ??£?¬¢ÿ¢
; ð??ö ÿ???ð? £òÿ?ÿ?????(«¥) ¡ð?÷??ÿ(?÷) ö£ý?¢ ?ÿ??????
; ?ÿ ô ?ý???????? ô??¬??÷ÿ¢????.
; ???????ð® ô?ý÷? ??£¢¡¯ ÷¡? ¡ð?÷??«, ?ÿ¥?ý¯©ð?¡¯ ?ÿ ­ò ÿ??,
; ¢? ?¡¢¬ ?¡?ð ð??ö ÿ???ð? ?ÿ??????, ¡¢ÿ «? ÷ÿ ðÿ?¢ ?ð?ý? £?? ?? ô ?¯÷ð¢¡¯

changeFont proc
	push AX
	push BX
	mov AX, 1100h
	mov BX, 1000h
	int 10h
	pop AX
	pop BX
	ret
changeFont endp

;=== ?£?ò¦ð¯ ¡?¥ ÿ???ð¯ ?? ?ÿ?¬???? ?ÿ§? ¢ÿ?ð¯ ¡ð?÷??ÿ
;===
; *** ÷¥?ý?«? ýÿ??«?
; BH - ¢ðô ÷??÷ ÿ©ÿ???? ¡ð?÷??¬??? ¢ÿö?ð¦«
;   0 - ¢ÿö?ð¦ÿ ð? int 1fh
;   1 - ¢ÿö?ð¦ÿ ð? int 44h
;   2-5 - ¢ÿö?ð¦ÿ ð? 8x14, 8x8, 8x8 (top), 9x14
;   6 - 8x16
;
; *** ?ôð¡ÿ?ð?  ÿö?¢« ô ?¦?ý£ «
; ? ?ð¡¥?ýð¢ ÷«??÷ int 10h (÷ðý??¡? ÷ð¡)
; ¡ ¤£?ò¦ð?? AH = 11h (¤£?ò¦ðð ??ÿò????? ÿ¢? ÿ)
; ?ÿ ÿ??¢  AL = 30 - ô?ý¤£?ò¦ð¯ ô??£§??ð¯ ð?¤? ?ÿ¦ðð ? EGA
;
; ***  ??£?¬¢ÿ¢
; ÷ ES:BP ?ÿ¥?ýð¢¡¯ ¢ÿö?ð¦ÿ ¡ð?÷???÷ (ô???ÿ¯)
; ÷ CX ?ÿ¥?ýð¢¡¯ öÿ?¢ ?ÿ ¡ð?÷??
; ÷ DL ò??ð§?¡¢÷? ­ò ÿ??«¥ ¡¢ ?ò
; ?????! ? ?ð¡¥?ýð¢ ¡ý÷ð?  ??ð¡¢ ÿ ES
; ( ES ¡¢ÿ??÷ð¢¡¯  ÿ÷?«? C000h )

saveFont proc
	push AX
	push BX
	mov AX, 1130h
	mov BX, 0600h
	int 10h
	pop AX
	pop BX
	ret
saveFont endp


;=== ?¢¡®ýÿ ?ÿ§ð?ÿ?¢¡¯ ÷«ô?????ð? ?¡??÷??? §ÿ¡¢ð ô ?? ÿ??« ===;
;===
_initTSR: ; ¡¢ÿ ¢  ??ðý??¢ÿ
	mov AH, 03h
	int 10h
	push DX
	mov AH,00h ; £¡¢ÿ??÷òÿ ÷ðý?? ??ð?ÿ (83h  ¢?ò¡¢  80x25  16/8  CGA,EGA  b800  Comp,RGB,Enhanced), ö?? ?§ð¡¢òð ­ò ÿ?ÿ
	mov AL,83h
	int 10h
	pop DX
	mov AH, 02h
	int 10h


    call commandParamsParser
	mov AX,3509h                    ; ô??£§ð¢¬ ÷ ES:BX ÷?ò¢?  09
    int 21h                         ; ô ? «÷ÿ?ð¯

	;@ === ?ýÿ???ð?  ??ðý??¢ÿ ð? ôÿ?¯¢ð ===
	;@ ?¡?ð ô? ÷ÿ ðÿ?¢£ ???ö¥?ýð?? ÷«? £?ÿ¢¬  ??ðý??¢ ô? ô?÷¢? ???£ ?ÿô£¡ò£ ô ð?????ð?,
	;@ ?£??? ?ÿò?????¢ð ?÷ÿ¢¬ ¡??ý£®©ð? 3 ¡¢ ?òð, ÿ ¢ÿò??
	;@ ¡?ý? ?ð??? ??¢òð _finishTSR ¤-ðð commandParamsParser, ?? ?? ¡ÿ?£ ??¢ò£!
	cmp unloadTSR, true
	je _removingOnParameter
	jmp _notRemovingNow

	_removingOnParameter:
		mov AH, 0FFh
		mov AL, 0
		int 2Fh
		cmp AH, 'i'  ; ô ?÷? òÿ ¢???, ?ÿ? £???ÿ ?ð £?? ô ?? ÿ??ÿ
		je _remove
		mov AH, 09h				;@ ý?¯ ÷«? £?òð  ??ðý??¢ÿ ô? ô?÷¢? ???£ ?ÿô£¡ò£ ?ÿò?????¢ð ?÷ÿ¢¬ ­¢£ ¡¢ ?ò£
		lea DX, notInstalledMsg	;@ ý?¯ ÷«? £?òð  ??ðý??¢ÿ ô? ô?÷¢? ???£ ?ÿô£¡ò£ ?ÿò?????¢ð ?÷ÿ¢¬ ­¢£ ¡¢ ?ò£
		int 21h					;@ ý?¯ ÷«? £?òð  ??ðý??¢ÿ ô? ô?÷¢? ???£ ?ÿô£¡ò£ ?ÿò?????¢ð ?÷ÿ¢¬ ­¢£ ¡¢ ?ò£
		int 20h					;@ ý?¯ ÷«? £?òð  ??ðý??¢ÿ ô? ô?÷¢? ???£ ?ÿô£¡ò£ ?ÿò?????¢ð ?÷ÿ¢¬ ­¢£ ¡¢ ?ò£

	_notRemovingNow:

	cmp notLoadTSR, true			; ?¡?ð ö«?ÿ ÷«÷?ý??ÿ ¡ô ÿ÷òÿ
	je _exit_tmp						; ô ?¡¢? ÷«¥?ýð?

	;@ ?¡?ð ô? ÷ÿ ðÿ?¢£ ???ö¥?ýð?? ÷«? £?ÿ¢¬  ??ðý??¢ ô? ô?÷¢? ???£ ?ÿô£¡ò£, ¢? ò?????¢ð £?? 5 ¡¢ ?ò ?ð??
	;@ ?¡?ð ???ö¥?ýð?? ÷«? £?ÿ¢¬ ô? ôÿ ÿ??¢ £ ò???ÿ?ý??? ¡¢ ?òð, ¢? ?¡¢ÿ÷?¯?? ð¥
	mov AH, 0FFh
	mov AL, 0
	int 2Fh
	cmp AH, 'i'  ; ô ?÷? òÿ ¢???, ?ÿ? £???ÿ ?ð £?? ô ?? ÿ??ÿ
	je _alreadyInstalled

	jmp _tmp

	_exit_tmp:
		jmp _exit

	_tmp:
	push ES
    mov AX, DS:[2Ch]                ; psp
    mov ES, AX
    mov AH, 49h                     ; ¥÷ÿ¢ð¢ ôÿ?¯¢ð §¢?ö ?¡¢ÿ¢¬¡¯
    int 21h                         ;  ??ðý??¢???
    pop ES
    jc _notMem                      ; ?? ¥÷ÿ¢ð?? - ÷«¥?ýð?

	;== int 09h ==;

	mov	word ptr CS:old_int9hOffset, BX
	mov	word ptr CS:old_int9hSegment, ES
    mov AX, 2509h                   ; £¡¢ÿ??÷ð? ÷?ò¢?  ?ÿ 09
    mov DX, offset new_int9h            ; ô ? «÷ÿ?ð?
    int 21h

	;== int 1Ch ==;
	mov AX,351Ch                    ; ô??£§ð¢¬ ÷ ES:BX ÷?ò¢?  1C
    int 21h                         ; ô ? «÷ÿ?ð¯
	mov	word ptr CS:old_int1ChOffset, BX
	mov	word ptr CS:old_int1ChSegment, ES
	mov AX, 251Ch                   ; £¡¢ÿ??÷ð? ÷?ò¢?  ?ÿ 1C
	mov DX, offset new_int1Ch            ; ô ? «÷ÿ?ð?
	int 21h

	;== int 2Fh ==;
	mov AX,352Fh                    ; ô??£§ð¢¬ ÷ ES:BX ÷?ò¢?  1C
    int 21h                         ; ô ? «÷ÿ?ð¯
	mov	word ptr CS:old_int2FhOffset, BX
	mov	word ptr CS:old_int2FhSegment, ES
	mov AX, 252Fh                   ; £¡¢ÿ??÷ð? ÷?ò¢?  ?ÿ 2F
	mov DX, offset new_int2Fh            ; ô ? «÷ÿ?ð?
	int 21h

	call changeFx
    mov DX, offset installedMsg         ; ÷«÷?ýð? §¢? ÷¡? ?ò
    mov AH, 9
    int 21h
    mov DX, offset _initTSR       ; ?¡¢ÿ??¡¯ ÷ ôÿ?¯¢ð  ??ðý??¢??
    int 27h                         ; ð ÷«¥?ýð?
    ; ò???¦ ?¡??÷??? ô ?? ÿ??«
_remove: ; ÷«? £?òÿ ô ?? ÿ??« ð? ôÿ?¯¢ð
	mov AH, 0FFh
	mov AL, 1
	int 2Fh
	jmp _exit
_alreadyInstalled:
	mov AH, 09h
	lea DX, alreadyInstalledMsg
	int 21h
	jmp _exit
_notMem:                            ; ?? ¥÷ÿ¢ÿ?¢ ôÿ?¯¢ð, §¢?ö« ?¡¢ÿ¢¬¡¯  ??ðý??¢??
    mov DX, offset noMemMsg
    mov AH, 9
    int 21h
_exit:                               ; ÷«¥?ý
    int 20h

;=== ? ?¦?ý£ ÿ ô ?÷? òð ôÿ ÿ??¢ ?÷ ò??. ¡¢ ?òð ===;
;===
commandParamsParser proc
	push CS
	pop ES
	mov unloadTSR, 0
	mov notLoadTSR, 0

	mov SI, 80h   				;SI=¡??©??ð? ò??ÿ?ý??? ¡¢ ?òð.
	lodsb        					;???£§ð? ò??-÷? ¡ð?÷???÷.
	or AL, AL     				;?¡?ð 0 ¡ð?÷???÷ ÷÷?ý???,
	jz _exitHelp   				;¢? ÷¡? ÷ ô? ¯ýò?.

	_nextChar:

	inc SI       					;??ô? ¬ SI £òÿ?«÷ÿ?¢ ?ÿ ô? ÷«? ¡ð?÷?? ¡¢ ?òð.

	cmp [SI], BYTE ptr 13
	je _exitHelp


		lodsw       				;???£§ÿ?? ý÷ÿ ¡ð?÷??ÿ
		cmp AX, '?/' 				;?¢? '/?' (ýÿ??«?  ÿ¡ô??????« ÷ ?ö ÿ¢??? ô? ¯ýò, ¢.?. AL:AH ÷??¡¢? AH:AL)
		je _question
		;cmp AX, 'u/'
		;je _finishTSR

		;cmp AH, '/'
		;je _errorParam

		jmp _exitHelp

	_question:
		; ÷«÷?ý ¡¢ ?òð ô???©ð
			mov AH,03
			int 10h
			lea BP, helpMsg
			mov CX, helpMsg_length
			mov BL, 0111b
			mov AX, 1301h
			int 10h
		; ò???¦ ÷«÷?ýÿ ¡¢ ?òð ô???©ð
		not notLoadTSR	        ;¤?ÿ? ¢???, §¢? ???ö¥?ýð?? ?? ?ÿ? £?ÿ¢¬  ??ðý??¢
		jmp _nextChar

	;@ === ?ýÿ???ð?  ??ðý??¢ÿ ð? ôÿ?¯¢ð ===
	;@ ?¡?ð ô? ÷ÿ ðÿ?¢£ ???ö¥?ýð?? ÷«? £?ÿ¢¬  ??ðý??¢ ô? ôÿ ÿ??¢ £ '/u' ò???ÿ?ý??? ¡¢ ?òð,
	;@ ?£??? ð¡ô??¬??÷ÿ¢¬ ¡??ý£®©ð? ò?ý, ÷ ?¡¢ÿ?¬?«¥ ¡?£§ÿ¯¥ ???ö¥?ýð?? ?ÿò?????ð¢ ?÷ÿ¢¬
	;@ ­¢?¢ ò?ý, ò ??? ?ÿ?÷ÿ?ð¯ ??¢òð! (ô? ???ÿ?ð® ????? ð?öÿ÷ð¢¬¡¯ ð ?¢ ??¢òð, ?? ÿòò£ ÿ¢?? ô ?¡??¢ ?¢¬ ð¡ô??¬??÷ÿ?ð?)
	_finishTSR:
		not unloadTSR		      ;¤?ÿ? ¢???, §¢? ???ö¥?ýð?? ÷«?£?ð¢¬  ??ðý??¢
		jmp _nextChar

	jmp _exitHelp

	_errorParam:
		;÷«÷?ý ¡¢ ?òð
			mov AH,03
			int 10h
			lea BP, CS:errorParamMsg
			mov CX, errorParamMsg_length
			mov BL, 0111b
			mov AX, 1301h
			int 10h
		;ò???¦ ÷«÷?ýÿ ¡¢ ?òð
	_exitHelp:
	ret
commandParamsParser endp

code ends
end _start
